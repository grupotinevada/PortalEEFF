<app-navbar></app-navbar>

<div class="container my-5">

  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
    <div>
      <h2 class="fw-bold text-success mb-0">
        <i class="bi bi-bar-chart-steps me-2"></i>Comparativo de Balances
      </h2>
      <p class="text-muted mb-0">Selecciona y gestiona los ejercicios contables a analizar.</p>
    </div>
    
    <div *ngIf="filtersForm.get('idEmpresa')?.value" 
         class="bg-white border border-success text-success px-3 py-2 rounded-pill shadow-sm d-flex align-items-center gap-2 mt-3 mt-md-0">
      <div class="bg-success rounded-circle p-1"></div>
      <span class="small fw-semibold text-uppercase">Empresa:</span>
      <strong class="fs-6">{{ filtersForm.get('idEmpresa')?.value }}</strong>
    </div>
  </div>

  <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5">
    <div class=" bg-success" style="height: 6px;"></div>
    
    <div class="card-body p-4">
      <div class="row g-4">
        
        <div class="col-12 col-lg-7 d-flex flex-column" [ngClass]="{'min-h-lg': true}">
          <h5 class="fw-bold text-secondary mb-3 small text-uppercase ls-1">
            <i class="bi bi-layers-half me-1"></i> Definición de Comparativa
          </h5>
          
          <div class="d-flex flex-column flex-md-row gap-3 align-items-stretch">
            
            <div class="flex-fill position-relative p-3 rounded-3 border border-success bg-success-subtle bg-opacity-10 d-flex flex-column justify-content-between transition-hover">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-success text-white mb-2">Actual (A)</span>
                <button *ngIf="balanceActual" 
                        (click)="deseleccionarBalance('actual')" 
                        class="btn btn-link text-success p-0 text-decoration-none" 
                        title="Quitar">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
              <div>
                <h4 class="mb-0 fw-bold text-success text-truncate">
                  {{ balanceActual?.ejercicio || '---' }}
                </h4>
                <small class="text-muted" *ngIf="!balanceActual">Selecciona de la lista</small>
              </div>
            </div>

        <button class="btn btn-outline-success border-2 rounded-circle p-2 shadow-sm d-flex justify-content-center align-items-center"
                style="width: 48px; height: 48px;"
                [disabled]="!balanceActual && !balanceAnterior"
                (click)="intercambiarBalances()"
                title="Intercambiar periodos">
        <i class="bi bi-arrow-left-right fs-5"></i>
        </button>


            <div class="flex-fill position-relative p-3 rounded-3 border border-info bg-info-subtle bg-opacity-10 d-flex flex-column justify-content-between">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-info text-dark mb-2">Anterior (B)</span>
                <button *ngIf="balanceAnterior" 
                        (click)="deseleccionarBalance('anterior')" 
                        class="btn btn-link text-info p-0 text-decoration-none" 
                        title="Quitar">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
              <div>
                <h4 class="mb-0 fw-bold text-dark text-truncate">
                  {{ balanceAnterior?.ejercicio || '---' }}
                </h4>
                <small class="text-muted" *ngIf="!balanceAnterior">Selecciona de la lista</small>
              </div>
            </div>

          </div>

          <div class="mt-auto pt-3">
            <button class="btn btn-success w-100 py-2 fw-semibold shadow-sm" 
                    [disabled]="!balanceActual || !balanceAnterior || showSpinner"
                    (click)="generarComparativo()">
              <i class="bi bi-play-circle-fill me-2"></i> Ejecutar Comparación
            </button>
          </div>
        </div>

        <div class="col-lg-1 d-none d-lg-flex justify-content-center">
          <div class="border-end h-100"></div>
        </div>

        <div class="col-12 col-lg-4">
          <h5 class="fw-bold text-secondary mb-3 small text-uppercase ls-1 mt-3 mt-lg-0">
            <i class="bi bi-funnel me-1"></i> Filtros de Búsqueda
          </h5>
          
          <form [formGroup]="filtersForm" (ngSubmit)="onApplyFilters()" class="d-flex flex-column gap-3 ">
            <div>
              <label for="empresaSelect" class="form-label fw-semibold text-dark">Empresa</label>
              <p-select id="empresaSelect" 
                        [options]="empresas" 
                        formControlName="idEmpresa" 
                        optionValue="id_empresa"
                        [showClear]="true" 
                        placeholder="Buscar empresa..." 
                        styleClass="w-100 p-inputtext-sm border-success-subtle"
                        [filter]="true"
                        filterBy="id_empresa,descripcion">
                  <ng-template let-empresa pTemplate="selectedItem">
                      <span *ngIf="empresa">{{ empresa.id_empresa }} - {{ empresa.descripcion }}</span>
                  </ng-template>
                  <ng-template let-empresa pTemplate="item">
                      <div>{{ empresa.id_empresa }} - {{ empresa.descripcion }}</div>
                  </ng-template>
              </p-select>
              <div class="form-text small text-muted fst-italic mt-1">
                <i class="bi bi-info-circle me-1"></i>Selecciona para cargar balances.
              </div>
            </div>

            <div class="mt-auto">
              <button type="submit" 
                      class="btn btn-outline-success w-100" 
                      [disabled]="filtersForm.invalid || showSpinner">
                <i class="bi" [ngClass]="showSpinner ? 'bi-arrow-repeat spin' : 'bi-search'"></i>
                Aplicar Filtro
              </button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <app-spinner [showSpinner]="showSpinner"></app-spinner>

  <div *ngIf="balances.length > 0 && !showSpinner" class="card border-0 shadow-sm rounded-4">
    <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex flex-column flex-md-row justify-content-between align-items-md-end">
      <div>
        <h5 class="fw-bold text-success mb-1">Balances Disponibles</h5>
        <p class="text-muted small mb-0">Haz clic en "Seleccionar" para asignar a los slots A o B.</p>
      </div>
      <span class="badge bg-light text-success border border-success px-3 py-2 rounded-pill mt-3 mt-md-0">
        Total: {{ total || balances.length }}
      </span>
    </div>

    <div class="card-body p-0 mt-2">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" style="border-collapse: separate; border-spacing: 0;">
          <thead class="bg-success bg-opacity-10 text-success">
            <tr>
              <th class="py-3 px-4 fw-semibold border-bottom-0 d-none d-sm-table-cell">ID</th> 
              <th class="py-3 fw-semibold border-bottom-0">Nombre Balance</th>
              <th class="py-3 text-center fw-semibold border-bottom-0 d-none d-md-table-cell">Ejercicio</th>
              <th class="py-3 text-end px-4 fw-semibold border-bottom-0">Acción</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let balance of balances" class="border-bottom border-light">
              <td class="px-4 text-muted small d-none d-sm-table-cell" style="max-width: 150px;">
                <span class="text-truncate d-block" title="{{ balance.id_blce }}">
                  {{ balance.id_blce }}
                </span>
              </td>
              <td class="fw-medium text-dark ps-4 ps-sm-2">
                <div class="fw-medium text-dark">{{ balance.nombre_conjunto }}</div>
                <span class="px-2 py-0 rounded bg-light text-dark fw-bold border d-md-none mt-1 d-inline-block">
                  {{ balance.ejercicio }}
                </span>
              </td>
              <td class="text-center d-none d-md-table-cell">
                <span class="px-3 py-1 rounded bg-light text-dark fw-bold border">
                  {{ balance.ejercicio }}
                </span>
                <div class="mt-1 d-flex justify-content-center gap-1">
                  <span *ngIf="balanceActual?.id_blce === balance.id_blce" class="badge bg-success tiny-badge">A</span>
                  <span *ngIf="balanceAnterior?.id_blce === balance.id_blce" class="badge bg-info text-dark tiny-badge">B</span>
                </div>
              </td>
              <td class="text-end px-4">
                <button type="button" 
                        class="btn btn-sm rounded-pill px-3 fw-medium transition-btn"
                        (click)="cargarBalanceCompleto(balance)"
                        [ngClass]="{
                          'btn-outline-dark border-2 text-dark shadow-sm bg-warning-subtle': balanceActual?.id_blce === balance.id_blce || balanceAnterior?.id_blce === balance.id_blce,
                          'btn-success shadow-sm': balanceActual?.id_blce !== balance.id_blce && balanceAnterior?.id_blce !== balance.id_blce
                        }">
                  <i class="bi me-1" 
                     [ngClass]="balanceActual?.id_blce === balance.id_blce || balanceAnterior?.id_blce === balance.id_blce ? 'bi-check2-circle' : 'bi-plus-lg'">
                  </i>
                  <span class="d-none d-sm-inline">{{ balanceActual?.id_blce === balance.id_blce || balanceAnterior?.id_blce === balance.id_blce ? 'Seleccionado' : 'Seleccionar' }}</span>
                  <span class="d-sm-none">{{ balanceActual?.id_blce === balance.id_blce || balanceAnterior?.id_blce === balance.id_blce ? 'Ok' : 'Sel.' }}</span>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div *ngIf="!showSpinner && total === 0 && filtersForm.get('idEmpresa')?.value" 
       class="alert alert-warning bg-warning-subtle border-warning border-0 rounded-3 mt-4 d-flex align-items-center p-4 shadow-sm" role="alert">
    <i class="bi bi-folder-x fs-2 me-3 text-warning"></i>
    <div>
      <h6 class="alert-heading fw-bold mb-1">No se encontraron balances</h6>
      <p class="mb-0 small">La empresa seleccionada no tiene balances registrados para comparar. Intenta con otra empresa.</p>
    </div>
  </div>

</div>

<app-spinner [showSpinner]="showSpinner"></app-spinner>

<style>
  @media (min-width: 992px) { /* Mínimo Large (lg) */
    .min-h-lg {
      min-height: 270px;
    }
  }
</style>