<p-dialog
  [header]="mode === 'create' ? 'Crear Nuevo Usuario' : 'Editar Usuario'"
  [(visible)]="display"
  [modal]="true"
  [style]="{width: '60vw'}"
  [draggable]="false"
  (onHide)="onCancel()">

  <div class="container-fluid pt-3">
    <div *ngIf="mode === 'edit' && userToEdit" class="mb-3 p-3 bg-light rounded">
      <h5 class="mb-1">Editando a: {{ userToEdit.username }}</h5>
      <span class="text-muted">{{ userToEdit.email }}</span>
    </div>

    <form [formGroup]="form">
      
      <div class="row" *ngIf="mode === 'create'">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="username" class="form-label">Nombre de Usuario:</label>
            <input id="username" type="text" formControlName="username" class="form-control"
                    [ngClass]="{ 'is-invalid': f['username'].touched && f['username'].invalid }">
            <div *ngIf="f['username'].touched && f['username'].invalid" class="invalid-feedback d-block">
              </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="email" class="form-label">Email:</label>
            <input id="email" type="email" formControlName="email" class="form-control"
                    [ngClass]="{ 'is-invalid': f['email'].touched && f['email'].invalid }">
            <div *ngIf="f['email'].touched && f['email'].invalid" class="invalid-feedback d-block">
              </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="permiso" class="form-label">Permiso (Rol):</label>
            <select id="permiso" formControlName="permiso" class="form-select"
                    [ngClass]="{ 'is-invalid': f['permiso'].touched && f['permiso'].invalid }">
              <option value="" disabled>Seleccione un permiso...</option>
              <option *ngFor="let permiso of permisosDisponibles" [value]="permiso.id">
                {{ permiso.nombre }}
              </option>
            </select>
            <div *ngIf="f['permiso'].touched && f['permiso'].invalid" class="invalid-feedback d-block">
              <small *ngIf="f['permiso'].errors?.['required']">Debe seleccionar un permiso.</small>
            </div>
          </div>
        </div>
        
        <div class="col-md-6" *ngIf="mode === 'edit'">
          <div class="mb-3">
            <label for="habilitado" class="form-label">Estado:</label>
            <select id="habilitado" formControlName="habilitado" class="form-select"
                    [ngClass]="{ 'is-invalid': f['habilitado'].touched && f['habilitado'].invalid }">
              <option [value]="1">Habilitado</option>
              <option [value]="0">Deshabilitado</option>
            </select>
            </div>
        </div>
      </div>

      <hr class="my-3">

      <div class="row">
        <div class="col-12">
          <fieldset class="mb-3" formGroupName="accesos">
            <legend class="form-label fs-6">Accesos del Usuario:</legend>
            <div class="d-flex">
              <div *ngFor="let acceso of accesosDisponibles" class="form-check form-check-inline me-4">
                <input class="form-check-input" type="checkbox" 
                        [formControlName]="acceso.id.toString()" [id]="'acceso-' + acceso.id">
                <label class="form-check-label" [for]="'acceso-' + acceso.id">
                  {{ acceso.nombre }}
                </label>
              </div>
            </div>
          </fieldset>
        </div>
      </div>

      <hr class="my-3">
      
      <div class="row">
        <div class="col-12">
           <div class="mb-3">
            <label for="password" class="form-label">Contrase√±a:</label>
            <input id="password" type="password" formControlName="password" class="form-control"
                   [placeholder]="mode === 'edit' ? 'Dejar en blanco para no cambiar' : ''"
                   [ngClass]="{ 'is-invalid': f['password'].touched && f['password'].invalid }">
            <div *ngIf="f['password'].touched && f['password'].invalid" class="invalid-feedback d-block">
              </div>
          </div>
        </div>
      </div>

    </form>
  </div>

  <ng-template pTemplate="footer">
    <button type="button" class="btn btn-secondary" (click)="onCancel()">
      <i class="pi pi-times me-1"></i>
      Cancelar
    </button>
    <button 
      type="button" 
      class="btn btn-primary" 
      [disabled]="isLoading || form.invalid"
      (click)="onSave()"
      style="width: 180px;">
      
      <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      <span *ngIf="!isLoading">
        <i class="pi pi-check me-1"></i>
        {{ mode === 'create' ? 'Crear Usuario' : 'Guardar Cambios' }}
      </span>
    </button>
  </ng-template>
</p-dialog>