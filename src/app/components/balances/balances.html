<app-navbar></app-navbar>

<main class="container-fluid">
  <div class="card shadow-sm border-0 mt-2 bg-transparent">
    <div class="card-body">
      <h5 class="fw-semibold mb-3 text-success">ðŸ§ª Filtros de bÃºsqueda</h5>
      
<form [formGroup]="filtersForm" (ngSubmit)="onApplyFilters()">
  <div class="row row-cols-1 row-cols-md-auto g-3 align-items-end mb-3">
    
    <div class="col">
      <label class="form-label block mb-1">Nombre conjunto</label>
      <input 
        pInputText 
        type="text" 
        class="w-100 p-inputtext-sm" 
        placeholder="Buscar por nombre..." 
        formControlName="nombre" 
      />
    </div>
    

    <div class="col">
      <label class="form-label block mb-1">Desde</label>
      <p-datepicker 
        formControlName="fechaInicio" 
        dateFormat="dd/mm/yy" 
        [showIcon]="true" 
        placeholder="dd/mm/aaaa"
        styleClass="w-100"
        inputStyleClass="p-inputtext-sm w-100">
      </p-datepicker>
    </div>

    <div class="col">
      <label class="form-label block mb-1">Hasta</label>
      <p-datepicker 
        formControlName="fechaFin" 
        dateFormat="dd/mm/yy" 
        [showIcon]="true" 
        placeholder="dd/mm/aaaa"
        styleClass="w-100"
        inputStyleClass="p-inputtext-sm w-100">
      </p-datepicker>
    </div>
        <div class="col">
      <label class="form-label d-block mb-1">Ejercicio</label>
      
      <p-select 
        [options]="anios" 
        formControlName="ejercicio" 
        placeholder="AÃ±o" 
        
        styleClass="p-inputtext-sm"
        appendTo="body" 
        styleClass="w-100" >
        </p-select>
    </div>
        <div class="col">
      <label class="form-label block mb-1">Empresa</label>
      <p-select 
        [options]="empresas" 
        formControlName="idEmpresa" 
        optionLabel="descripcion" 
        optionValue="id_empresa" 
        placeholder="Todos" 
        
        styleClass="w-100">
      </p-select>
    </div>

    <div class="col">
      <label class="form-label block mb-1">Mapping</label>
      <p-select 
        [options]="mappings" 
        formControlName="idMapping" 
        optionValue="id_mapping" 
        placeholder="Todas" 
        
        styleClass="w-100" 
        [filter]="true" 
        filterBy="descripcion">
        
        <ng-template let-item #selectedItem>
           {{ item.id_mapping }} - {{ item.descripcion }}
        </ng-template>
        <ng-template let-item #item>
           {{ item.id_mapping }} - {{ item.descripcion }}
        </ng-template>
      </p-select>
    </div>

    <div class="col">
      <label class="form-label block mb-1">Estado</label>
      <p-select 
        [options]="estados" 
        formControlName="idEstado" 
        optionLabel="desc" 
        optionValue="id_estado" 
        placeholder="Todos" 
        
        styleClass="w-100">
      </p-select>
    </div>



    <div class="col d-flex gap-1 ">
      <div class="col d-flex gap-1">
        <button type="submit" class="btn btn-warning btn-sm text-white">
          <i class="bi bi-funnel-fill"></i> Filtrar
        </button>
      </div>
      
      <button type="button" class="btn btn-secondary btn-sm" (click)="onResetFilters()">
          <i class="bi bi-eraser-fill"></i>Limpiar
      </button>
        
      <button type="button" class="btn btn-outline-primary btn-sm" disabled>
          <i class="bi bi-download"></i> Exportar Lista de balances
      </button>
    </div>
  </div>
</form>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th>Ejercicio</th>
              <th>Empresa</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>CreaciÃ³n</th>
              <th>Mapping</th>
              <th>Estado</th>
              <th>Usuario</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody *ngIf="!loading">
            <ng-container *ngIf="balances.length > 0; else noData">
              <tr *ngFor="let b of balances; let i = index">
                <td>{{ (page - 1) * limit + i + 1 }}</td>
                <td>
                  <div class="fw-semibold">{{ b.nombre_conjunto }}</div>
                </td>
                <td>{{ b.ejercicio }}</td>
                <td>{{ b.id_empresa }} - {{ b.empresa_desc }}</td>
                <td>{{ b.fecha_inicio | date: 'dd-MM-yyyy'}}</td>
                <td>{{ b.fecha_fin | date: 'dd-MM-yyyy'}}</td>
                <td>{{ b.fecha_creacion| date: 'dd-MM-yyyy'}}</td>
                <td>
                  <span class="badge bg-light text-dark">{{ b.id_mapping }} </span>
                </td>
                <td>
                  <span class="badge" [ngStyle]="{'background-color': b.estado_color, 'color': 'white'}">
                    {{ b.estado_desc }}
                  </span>
                </td>
                <td>
                  <div class="fw-semibold">{{ b.username || "Usuario" }}</div>
                  <div class="small text-muted">{{ b.email || "Usuario" }}</div>
                </td>
                <td class="text-nowrap">
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm me-1"
                  title="Editar"
                  (click)="abrirModalEdicion(b.id_blce)"
                >
                  <i class="bi bi-pencil"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-outline-info btn-sm me-1"
                  title="Ver"
                  (click)="abrirModal(b.id_blce)"
                >
                  <i class="bi bi-eye"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-outline-danger btn-sm"
                  title="Eliminar"
                  disabled
                >
                  <i class="bi bi-trash"></i>
                </button>
              </td>
              </tr>
            </ng-container>

          <ng-template #noData>
          
            <tr>
              <td colspan="11" class="py-4 align-middle">
                <div class="alert alert-info d-flex align-items-center justify-content-center mb-0 w-100 h-100" role="alert" style="min-height:120px;">
                  <i class="bi bi-info-circle me-2"></i>
                  No se encontraron resultados.
                </div>
              </td>
            </tr>
          
        </ng-template>
          </tbody>
        </table>
      </div>



      <nav *ngIf="!loading && totalPages > 0" class="mt-3" aria-label="PaginaciÃ³n de balances">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="page === 1">
            <a class="page-link" href="#" (click)="$event.preventDefault(); onPageChange(page - 1)">Anterior</a>
          </li>
          <li *ngFor="let p of pages" class="page-item" [class.active]="p === page">
            <a class="page-link" href="#" (click)="$event.preventDefault(); onPageChange(p)">{{ p }}</a>
          </li>
          <li class="page-item" [class.disabled]="page === totalPages">
            <a class="page-link" href="#" (click)="$event.preventDefault(); onPageChange(page + 1)">Siguiente</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  
</main>

<app-spinner [showSpinner]="loading"></app-spinner>